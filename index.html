<!DOCTYPE html>
<html>

  <head>
    <title>hawtio-kubernetes-api</title>
    <base href='/'></base>
    <meta charset="UTF8">

    <!-- bower:css -->
    <!-- endbower -->
    <link rel="stylesheet" type="text/css" href="libs/bootstrap/dist/css/bootstrap.css">

    <!-- ES6/ES6 shim -->
    <!--[if IE 8]>
    <script src="libs/es5-dom-shim/__COMIPLE/a.ie8.js"></script>
    <![endif]-->
    <script src="libs/es5-dom-shim/__COMPILE/a.js"></script>

    <!-- bower:js -->
    <script src="libs/jquery/dist/jquery.js"></script>
    <script src="libs/angular/angular.js"></script>
    <script src="libs/angular-resource/angular-resource.js"></script>
    <script src="libs/angular-sanitize/angular-sanitize.js"></script>
    <script src="libs/js-logger/src/logger.js"></script>
    <script src="libs/hawtio-core/hawtio-core.js"></script>
    <script src="libs/lodash/lodash.js"></script>
    <script src="libs/angular-route/angular-route.js"></script>
    <script src="libs/uri.js/src/URI.js"></script>
    <script src="libs/uri.js/src/IPv6.js"></script>
    <script src="libs/uri.js/src/SecondLevelDomains.js"></script>
    <script src="libs/uri.js/src/punycode.js"></script>
    <script src="libs/uri.js/src/URITemplate.js"></script>
    <script src="libs/uri.js/src/jquery.URI.js"></script>
    <script src="libs/uri.js/src/URI.min.js"></script>
    <script src="libs/uri.js/src/jquery.URI.min.js"></script>
    <script src="libs/uri.js/src/URI.fragmentQuery.js"></script>
    <script src="libs/uri.js/src/URI.fragmentURI.js"></script>
    <script src="libs/hawtio-core-navigation/dist/hawtio-core-navigation.js"></script>
    <script src="libs/urijs/src/URI.js"></script>
    <script src="libs/hawtio-utilities/dist/sugar.js"></script>
    <script src="libs/hawtio-utilities/dist/angular-file-upload.js"></script>
    <script src="libs/hawtio-utilities/dist/hawtio-utilities.js"></script>
    <script src="libs/keycloak/dist/keycloak.js"></script>
    <script src="libs/ng-idle/angular-idle.js"></script>
    <script src="libs/hawtio-oauth/dist/hawtio-oauth.js"></script>
    <!-- endbower -->

    <script src="libs/bootstrap/dist/js/bootstrap.js"></script>
  </head>

  <body>
    <script type="text/ng-template" id="data">
      <h4>{{objectKind}}</h4>
      <span class="pull-right"><a title="Delete block" href="" ng-click="deleteScope()">X</a></span>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Delete</th>
            <th>Kind</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody>
          <tr ng-repeat="obj in objects track by $index">
            <td><a href="" ng-click="delete(obj)">X</a>
            <td>{{obj.kind}}</td>
            <td>{{obj.metadata.name}}</td>
          </tr>
        </tbody>
      </table>
    </script>
    <div ng-controller="TestNamespacesController">
      <div ng-include="'data'"></div>
      <div>
        <a href="" class="btn btn-default" ng-click="create()">Create</a>
      </div>
    </div>
    <div ng-controller="TestNamespacesController">
      <div ng-include="'data'"></div>
      <div>
        <a href="" class="btn btn-default" ng-click="create()">Create</a>
      </div>
    </div>
    <div ng-controller="TestPodsController">
      <div ng-include="'data'"></div>
      <div>
        <a href="" class="btn btn-default" ng-click="create()">Create</a>
      </div>
    </div>
    <div ng-controller="TestServicesController">
      <div ng-include="'data'"></div>
      <div>
        <a href="" class="btn btn-default" ng-click="create()">Create</a>
      </div>
    </div>
    <div ng-controller="TestProjectsController">
      <div ng-include="'data'"></div>
      <div>
        <a href="" class="btn btn-default" ng-click="create()">Create</a>
      </div>
    </div>
    <script>

      function initScope(factory, $scope, $element, kind, namespace) {
        $scope.objectKind = kind;
        $scope.namespace = namespace;
        var client = $scope.client = factory.create(kind, namespace);
        var handle = client.watch(function(objects) {
          console.log("Callback fired for kind: ", kind);
          $scope.objects = objects;
          $scope.$apply();
        });
        $scope.$watchCollection('objects', function(newValue) {
          console.log($scope.objectKind + " collection changed");
        });
        $scope.delete = function(obj) {
          client.delete(obj, function(obj) {
            console.log("Deleted: ", obj);
          });
        };
        $scope.create = function() {
          var item = _.cloneDeep(_.sample($scope.objects));
          delete item.metadata.resourceVersion;
          delete item.metadata.uid;
          item.metadata.name = "new-" + item.metadata.name;
          client.put(item, function(obj) {
            console.log("Created: ", obj);         
          });
        };
        $element.on('$destroy', () => {
          $scope.$destroy();
        });
        $scope.$on('$destroy', () => {
          factory.destroy(client, handle);
        });
        $scope.deleteScope = function() {
          $element.remove();
        }
        client.connect();
      }

      var _module = angular.module('Test', []);
      _module.controller('TestNamespacesController', function($scope, $element, K8SClientFactory) {
        initScope(K8SClientFactory, $scope, $element, 'namespaces');
      });
      _module.controller('TestPodsController', function($scope, $element, K8SClientFactory) {
        initScope(K8SClientFactory, $scope, $element, 'pods', 'default');
      });
      _module.controller('TestServicesController', function($scope, $element, K8SClientFactory) {
        initScope(K8SClientFactory, $scope, $element, 'services');
      });
      _module.controller('TestProjectsController', function($scope, $element, K8SClientFactory) {
        initScope(K8SClientFactory, $scope, $element, 'projects');
      });
      hawtioPluginLoader.addModule('Test');
    </script>

    <!-- add any scripts under dist/ here -->
    <script src="dist/smokesignals.unminified.js"></script>
    <script src="dist/hawtio-kubernetes-api.js"></script>
  </body>
</html>
